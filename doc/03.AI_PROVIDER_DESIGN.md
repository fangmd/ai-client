# AI Provider 模型管理设计方案

## 一、概述

### 1.1 功能目标

AI Provider 模型管理模块负责管理应用中使用的 AI 服务提供商配置，支持用户添加、配置和管理多个 AI 模型（如 OpenAI、Anthropic、自定义服务等）。

### 1.2 核心功能点

- **模型配置管理**：创建、查询、删除 AI Provider 配置
- **默认模型设置**：支持设置/切换默认 AI Provider
- **多提供商支持**：支持 OpenAI、Anthropic、Custom 等多种提供商类型
- **参数配置**：支持配置 API Key、Base URL、Temperature、Max Tokens 等参数

### 1.3 技术选型

- **数据库**：SQLite + Prisma ORM
- **IPC 通信**：Electron IPC（invoke/handle 模式）
- **前端组件**：React + shadcn/ui
- **ID 生成**：Snowflake ID（BigInt）

## 二、数据库设计

### 2.1 Prisma Schema

```prisma
model AiProvider {
  id           BigInt   @id
  name         String?  // 提供商名称（可选，用于标识）
  provider     String   // 提供商类型: openai, anthropic, custom
  apiKey       String   // API 密钥
  baseURL      String?  // 基础 URL（可选）
  model        String   // 模型名称
  temperature  Float?   // 温度参数（可选）
  maxTokens    Int?     // 最大 token 数（可选）
  organization String?  // OpenAI 组织 ID（可选）
  isDefault    Boolean  @default(false) // 是否默认提供商
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([provider])
  @@index([isDefault])
  @@map("ai_provider")
}
```

### 2.2 字段说明

| 字段         | 类型     | 必填 | 说明                                   |
| ------------ | -------- | ---- | -------------------------------------- |
| id           | BigInt   | 是   | 主键 ID（Snowflake ID）                |
| name         | String   | 否   | 用户自定义名称，便于识别               |
| provider     | String   | 是   | 提供商类型: openai, anthropic, custom  |
| apiKey       | String   | 是   | API 密钥                               |
| baseURL      | String   | 否   | 自定义 API 地址，用于代理或私有部署    |
| model        | String   | 是   | 模型名称（如 gpt-4, claude-3-opus）    |
| temperature  | Float    | 否   | 温度参数，控制输出随机性（0-2）        |
| maxTokens    | Int      | 否   | 最大生成 token 数                      |
| organization | String   | 否   | OpenAI 组织 ID                         |
| isDefault    | Boolean  | 是   | 是否为默认提供商，默认 false           |
| createdAt    | DateTime | 是   | 创建时间，自动生成                     |
| updatedAt    | DateTime | 是   | 更新时间，自动更新                     |

### 2.3 索引设计

- `@@index([provider])`：按提供商类型查询优化
- `@@index([isDefault])`：查询默认提供商优化

## 三、架构设计

### 3.1 分层架构图

```
┌─────────────────────────────────────────────────────────┐
│              Renderer 层 (UI)                           │
│  - AiModelList.tsx          # 模型列表组件              │
│  - AddAiModelDialog.tsx     # 添加模型对话框            │
└───────────────────────┬─────────────────────────────────┘
                        │ IPC 通信
┌───────────────────────▼─────────────────────────────────┐
│              IPC 层 (通信桥梁)                          │
│  - IPC_CHANNELS.aiProvider.*                            │
│  - IPCResponse<T> 类型定义                              │
└───────────────────────┬─────────────────────────────────┘
                        │ IPC 调用
┌───────────────────────▼─────────────────────────────────┐
│              Main Handler 层                            │
│  - AIProviderHandler                                    │
│  - 请求路由和分发                                        │
└───────────────────────┬─────────────────────────────────┘
                        │ 调用
┌───────────────────────▼─────────────────────────────────┐
│              Repository 层                              │
│  - ai-provider.ts                                       │
│  - 数据访问和业务逻辑                                    │
└───────────────────────┬─────────────────────────────────┘
                        │ Prisma ORM
┌───────────────────────▼─────────────────────────────────┐
│              Database 层 (SQLite)                       │
│  - ai_provider 表                                       │
└─────────────────────────────────────────────────────────┘
```

### 3.2 设计模式

- **Repository 模式**：封装数据访问逻辑，提供统一的数据操作接口
- **Handler 模式**：统一处理 IPC 请求，实现请求路由和分发
- **事务模式**：设置默认 Provider 时使用事务确保数据一致性

## 四、目录结构

```
src/
├── main/
│   ├── handlers/
│   │   └── ai-provider-handler.ts    # IPC Handler
│   └── repository/
│       └── ai-provider.ts            # Repository 层
├── common/
│   └── constants/
│       └── ipc.ts                    # IPC 通道常量
├── types/
│   └── ai-provider-type.ts           # 类型定义
└── renderer/
    └── src/
        └── components/
            ├── AiModelList.tsx       # 模型列表组件
            └── AddAiModelDialog.tsx  # 添加模型对话框
```

## 五、核心接口设计

### 5.1 实体类型

```typescript
/**
 * AI Provider 类型（数据库实体）
 */
interface AiProvider {
  id: bigint              // 主键 ID（Snowflake ID）
  name: string | null     // 提供商名称
  provider: string        // 提供商类型: openai, anthropic, custom
  apiKey: string          // API 密钥
  baseURL: string | null  // 基础 URL
  model: string           // 模型名称
  temperature: number | null  // 温度参数
  maxTokens: number | null    // 最大 token 数
  organization: string | null // OpenAI 组织 ID
  isDefault: boolean      // 是否默认提供商
  createdAt: Date         // 创建时间
  updatedAt: Date         // 更新时间
}
```

### 5.2 创建数据类型

```typescript
/**
 * AI Provider 创建数据
 */
interface CreateAiProviderData {
  name?: string | null
  provider: string        // 必填：openai, anthropic, custom
  apiKey: string          // 必填：API 密钥
  baseURL?: string | null
  model: string           // 必填：模型名称
  temperature?: number | null
  maxTokens?: number | null
  organization?: string | null
  isDefault?: boolean
}
```

### 5.3 更新数据类型

```typescript
/**
 * AI Provider 更新数据（基于 Prisma 类型）
 */
type UpdateAiProviderData = Prisma.AiProviderUpdateInput
```

## 六、IPC 通道定义

### 6.1 通道常量

```typescript
export const IPC_CHANNELS = {
  aiProvider: {
    create: 'ai-provider:create',       // 创建 AI Provider
    list: 'ai-provider:list',           // 获取所有 AI Provider
    getDefault: 'ai-provider:get-default', // 获取默认 AI Provider
    delete: 'ai-provider:delete',       // 删除 AI Provider
    setDefault: 'ai-provider:set-default'  // 设置默认 AI Provider
  }
} as const
```

### 6.2 IPC 请求/响应类型

```typescript
interface AiProviderIPC {
  create: {
    request: CreateAiProviderData
    response: IPCResponse<AiProvider>
  }
  list: {
    request: void
    response: IPCResponse<AiProvider[]>
  }
  getDefault: {
    request: void
    response: IPCResponse<AiProvider | null>
  }
  delete: {
    request: bigint  // Provider ID
    response: IPCResponse<null>
  }
  setDefault: {
    request: bigint  // Provider ID
    response: IPCResponse<AiProvider>
  }
}
```

## 七、Repository 层设计

### 7.1 函数签名

```typescript
/**
 * 创建 AI Provider
 */
function createAiProvider(data: Omit<CreateAiProviderData, 'id'>): Promise<AiProvider>

/**
 * 查询所有 AI Provider
 */
function getAllAiProviders(): Promise<AiProvider[]>

/**
 * 根据 ID 查询 AI Provider
 */
function getAiProviderById(id: bigint): Promise<AiProvider | null>

/**
 * 查询默认 AI Provider
 */
function getDefaultAiProvider(): Promise<AiProvider | null>

/**
 * 根据提供商类型查询 AI Provider
 */
function getAiProvidersByType(provider: string): Promise<AiProvider[]>

/**
 * 更新 AI Provider
 */
function updateAiProvider(id: bigint, data: UpdateAiProviderData): Promise<AiProvider>

/**
 * 删除 AI Provider
 */
function deleteAiProvider(id: bigint): Promise<AiProvider>

/**
 * 设置默认 AI Provider（使用事务）
 * 会自动取消其他 Provider 的默认状态
 */
function setDefaultAiProvider(id: bigint): Promise<AiProvider>

/**
 * 取消默认 AI Provider
 */
function unsetDefaultAiProvider(id: bigint): Promise<AiProvider>

/**
 * 检查是否存在默认 Provider
 */
function hasDefaultProvider(): Promise<boolean>
```

### 7.2 事务处理

设置默认 Provider 时使用 Prisma 事务确保数据一致性：

```typescript
async function setDefaultAiProvider(id: bigint) {
  return prisma.$transaction(async (tx) => {
    // 1. 先取消所有默认状态
    await tx.aiProvider.updateMany({
      where: { isDefault: true },
      data: { isDefault: false }
    })
    // 2. 设置新的默认 Provider
    return tx.aiProvider.update({
      where: { id },
      data: { isDefault: true }
    })
  })
}
```

## 八、前端组件设计

### 8.1 AiModelList 组件

模型列表组件，展示所有已配置的 AI Provider。

**功能**：
- 展示所有 AI Provider 列表
- 显示默认标识
- 支持删除操作
- 支持设置默认操作
- 打开添加模型对话框

**状态管理**：使用组件内部 useState 管理状态

```typescript
// 组件状态
const [providers, setProviders] = useState<AiProvider[]>([])
const [loading, setLoading] = useState(true)
const [dialogOpen, setDialogOpen] = useState(false)
```

### 8.2 AddAiModelDialog 组件

添加模型对话框组件。

**Props 定义**：

```typescript
interface AddAiModelDialogProps {
  open: boolean                    // 对话框是否打开
  onOpenChange: (open: boolean) => void  // 打开状态变化回调
  onSuccess?: () => void           // 创建成功回调
}
```

**表单字段**：

| 字段         | 类型     | 必填 | 说明                     |
| ------------ | -------- | ---- | ------------------------ |
| name         | text     | 否   | 名称（用于标识）         |
| provider     | select   | 是   | 提供商类型               |
| apiKey       | password | 是   | API 密钥                 |
| baseURL      | text     | 否   | 基础 URL                 |
| model        | text     | 是   | 模型名称                 |
| temperature  | range    | 否   | 温度参数（0-2）          |
| maxTokens    | number   | 否   | 最大 token 数            |
| organization | text     | 否   | OpenAI 组织 ID（条件显示）|
| isDefault    | checkbox | 否   | 是否设为默认             |

## 九、实现步骤

### 阶段一：数据库设计
1. ✅ 设计 Prisma Schema
2. ✅ 创建数据库迁移

### 阶段二：类型定义
1. ✅ 定义 AiProvider 实体类型
2. ✅ 定义 CreateAiProviderData 类型
3. ✅ 定义 UpdateAiProviderData 类型

### 阶段三：IPC 通道定义
1. ✅ 定义 IPC_CHANNELS.aiProvider 常量

### 阶段四：Repository 层实现
1. ✅ 实现 createAiProvider
2. ✅ 实现 getAllAiProviders
3. ✅ 实现 getAiProviderById
4. ✅ 实现 getDefaultAiProvider
5. ✅ 实现 getAiProvidersByType
6. ✅ 实现 updateAiProvider
7. ✅ 实现 deleteAiProvider
8. ✅ 实现 setDefaultAiProvider（事务）
9. ✅ 实现 unsetDefaultAiProvider
10. ✅ 实现 hasDefaultProvider

### 阶段五：Handler 层实现
1. ✅ 实现 AIProviderHandler.register()
2. ✅ 实现 create 处理器
3. ✅ 实现 list 处理器
4. ✅ 实现 getDefault 处理器
5. ✅ 实现 delete 处理器
6. ✅ 实现 setDefault 处理器
7. ✅ 实现 AIProviderHandler.unregister()

### 阶段六：前端组件实现
1. ✅ 实现 AiModelList 组件
2. ✅ 实现 AddAiModelDialog 组件

## 十、注意事项

### 10.1 安全性

- **API Key 存储**：API Key 以明文存储在本地 SQLite 数据库中，仅适用于本地桌面应用场景
- **密码输入框**：前端 API Key 输入使用 `type="password"` 防止直接可见

### 10.2 数据一致性

- **默认 Provider 唯一性**：设置默认 Provider 时使用事务，确保同一时间只有一个默认 Provider
- **BigInt 处理**：前端与后端传递 BigInt 时需要转换为字符串（JSON 不支持 BigInt）

### 10.3 错误处理

- 所有 IPC 请求使用 try-catch 包装
- 使用 `responseSuccess` 和 `responseError` 统一响应格式
- 前端展示友好的错误提示

### 10.4 性能优化

- 使用索引优化查询（provider、isDefault）
- 列表按创建时间倒序排列

## 十一、扩展功能（未来）

### 11.1 模型编辑功能

**状态**：⚠️ 暂时不做

**功能**：支持编辑已有的 AI Provider 配置

**说明**：当前版本仅支持添加和删除，编辑功能将在后续版本实现。

### 11.2 API Key 验证

**状态**：⚠️ 暂时不做

**功能**：添加模型时验证 API Key 是否有效

**说明**：需要调用各提供商的验证接口，将在后续版本实现。

### 11.3 模型分组管理

**状态**：⚠️ 暂时不做

**功能**：支持按分组管理多个模型配置

**说明**：当模型数量增多时提供更好的管理体验。

### 11.4 配置导入导出

**状态**：⚠️ 暂时不做

**功能**：支持导入/导出 AI Provider 配置（不含 API Key）

**说明**：方便在多设备间同步配置。

