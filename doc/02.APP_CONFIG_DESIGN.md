# 应用配置功能设计方案

## 一、概述

实现应用配置的持久化存储和管理功能，包括主题设置等应用级别的配置数据。配置数据存储在 SQLite 数据库中，通过 IPC 通信实现主进程和渲染进程的数据同步。

## 二、数据库设计

### 2.1 数据模型

采用简洁的 Key-Value 结构存储配置。

```prisma
model Config {
  key       String   @id       // 配置键（唯一标识）
  value     String             // 配置值
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("config")
}
```

### 2.2 预定义配置项

| Key | Default | Description |
|-----|---------|-------------|
| `theme` | `"system"` | 主题模式: light, dark, system |

## 三、架构设计

```
┌─────────────────────────────────────────┐
│      Renderer 层 (UI)                   │
│  - SettingsPage                         │
│  - configStore (Zustand)                │
│  - theme.ts (主题工具函数)               │
└──────────────┬──────────────────────────┘
               │ IPC 通信
┌──────────────▼──────────────────────────┐
│      Main Handler 层                    │
│  - ConfigHandler                        │
└──────────────┬──────────────────────────┘
               │ 调用
┌──────────────▼──────────────────────────┐
│      Repository 层                       │
│  - config.ts                             │
└──────────────┬──────────────────────────┘
               │ Prisma ORM
┌──────────────▼──────────────────────────┐
│      Database 层 (SQLite)               │
└─────────────────────────────────────────┘
```

## 四、目录结构

```
src/
├── main/
│   ├── handlers/
│   │   └── config-handler.ts        # 配置 IPC Handler
│   └── repository/
│       └── config.ts                # 配置 Repository
├── common/
│   └── constants/
│       └── ipc.ts                   # IPC 通道常量
├── renderer/
│   └── src/
│       ├── stores/
│       │   └── configStore.ts       # 配置状态管理
│       ├── utils/
│       │   └── theme.ts             # 主题工具函数
│       └── page/
│           └── settings.tsx         # 设置页面
└── types/
    └── config-type.ts               # 配置类型定义
```

## 五、IPC 接口

### 5.1 通道定义

| 通道 | 说明 |
|------|------|
| `config:get` | 获取单个配置 |
| `config:get-all` | 获取所有配置 |
| `config:set` | 设置配置 |
| `config:delete` | 删除配置 |

### 5.2 Repository 接口

| 函数 | 说明 |
|------|------|
| `getConfig(key)` | 获取单个配置 |
| `getConfigValue<T>(key, defaultValue)` | 获取配置值（带默认值） |
| `getAllConfigs()` | 获取所有配置 |
| `setConfig(key, value)` | 设置配置（upsert） |
| `deleteConfig(key)` | 删除配置 |

## 六、类型定义

```typescript
// src/types/config-type.ts

export interface ConfigItem {
  key: string
  value: string
  createdAt?: Date
  updatedAt?: Date
}

export type ThemeMode = 'light' | 'dark' | 'system'

export const CONFIG_KEYS = {
  THEME: 'theme'
} as const

export const DEFAULT_CONFIG = {
  [CONFIG_KEYS.THEME]: 'system' as ThemeMode
} as const
```

## 七、前端 Store

```typescript
interface ConfigState {
  theme: ThemeMode
  loadConfig: () => Promise<void>
  setTheme: (mode: ThemeMode) => Promise<void>
}
```

## 八、主题切换流程

### 8.1 应用启动

```
App.tsx useEffect → loadConfig() → IPC: config:getAll
    → 解析配置 → applyTheme() → setupSystemThemeListener()
```

### 8.2 用户切换

```
点击主题按钮 → setTheme() → IPC: config:set
    → 更新 store → applyTheme() → setupSystemThemeListener()
```

## 九、实现状态

- ✅ 数据库 Schema 和迁移
- ✅ 类型定义
- ✅ IPC 通道
- ✅ Repository 层
- ✅ Handler 层
- ✅ configStore
- ✅ 主题工具函数
- ✅ 设置页面

## 十、扩展功能（未来）

1. **更多配置项**：语言设置、字体大小、其他外观配置
2. **配置导入/导出**：导出到 JSON、从文件导入
