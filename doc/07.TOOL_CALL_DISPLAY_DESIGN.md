# å·¥å…·è°ƒç”¨æ¶ˆæ¯æ˜¾ç¤ºè®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€èƒŒæ™¯

OpenAI Responses API æ”¯æŒå†…ç½®å·¥å…·ï¼ˆå¦‚ `web_search`ã€`file_search`ï¼‰ï¼Œåœ¨ AI å¤„ç†è¯·æ±‚æ—¶ä¼šè°ƒç”¨è¿™äº›å·¥å…·ã€‚å½“å‰å®ç°ä¸­ï¼Œå·¥å…·è°ƒç”¨è¿‡ç¨‹å¯¹ç”¨æˆ·ä¸å¯è§ï¼Œåªèƒ½çœ‹åˆ°æœ€ç»ˆçš„ AI å›å¤ã€‚ä¸ºäº†æå‡ç”¨æˆ·ä½“éªŒï¼Œéœ€è¦å°†å·¥å…·è°ƒç”¨çš„è¿‡ç¨‹å±•ç¤ºåœ¨ç•Œé¢ä¸Šï¼Œè®©ç”¨æˆ·äº†è§£ AI æ­£åœ¨åšä»€ä¹ˆã€‚

### 1.1 å·¥å…·è°ƒç”¨æµç¨‹

æ ¹æ®å®é™…æ—¥å¿—åˆ†æï¼ŒResponses API çš„å·¥å…·è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š

```
1. response.output_item.added
   â””â”€ item: { type: 'web_search_call', status: 'in_progress' }

2. response.web_search_call.in_progress
   â””â”€ å·¥å…·è°ƒç”¨å‡†å¤‡ä¸­

3. response.web_search_call.searching
   â””â”€ æ­£åœ¨æœç´¢

4. response.web_search_call.completed
   â””â”€ æœç´¢å®Œæˆï¼ˆä½†è¿˜æ²¡æœ‰è¯¦ç»†ä¿¡æ¯ï¼‰

5. response.output_item.done
   â””â”€ item: { action: { type: 'search', query: 'weather: Beijing, China' } }
   â””â”€ è·å–å®Œæ•´çš„å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼ˆåŒ…å«æŸ¥è¯¢å†…å®¹ï¼‰

6. response.output_item.added (type: 'message')
   â””â”€ AI å¼€å§‹è¾“å‡ºæ–‡æœ¬å“åº”

7. response.output_text.delta
   â””â”€ æµå¼è¾“å‡º AI å›å¤å†…å®¹
```

## äºŒã€æ–¹æ¡ˆè®¾è®¡

### 2.1 æ ¸å¿ƒæ€è·¯

å°†å·¥å…·è°ƒç”¨ä½œä¸ºç‰¹æ®Šç±»å‹çš„æ¶ˆæ¯å­˜å‚¨å’Œå±•ç¤ºï¼Œå®Œæ•´è®°å½•å¯¹è¯å†å²ï¼š

```
ç”¨æˆ·æ¶ˆæ¯
  â†“
å·¥å…·è°ƒç”¨æ¶ˆæ¯ï¼ˆè¿›è¡Œä¸­ï¼‰
  â†“
å·¥å…·è°ƒç”¨æ¶ˆæ¯ï¼ˆå®Œæˆï¼‰
  â†“
AI å›å¤æ¶ˆæ¯
```

### 2.2 æŠ€æœ¯æ–¹æ¡ˆ

#### æ–¹æ¡ˆå¯¹æ¯”

**æ–¹æ¡ˆAï¼šå·¥å…·è°ƒç”¨ä½œä¸ºæ¶ˆæ¯ç±»å‹**
- ä¼˜ç‚¹ï¼šå®Œæ•´è®°å½•å¯¹è¯å†å²ï¼Œä¾¿äºæŸ¥è¯¢å’Œå±•ç¤ºï¼Œæ•°æ®ç»“æ„æ¸…æ™°
- ç¼ºç‚¹ï¼šéœ€è¦ä¿®æ”¹è¾ƒå¤šç°æœ‰ä»£ç ï¼Œæ¶ˆæ¯ç±»å‹å˜å¤æ‚

**æ–¹æ¡ˆBï¼šå·¥å…·è°ƒç”¨ä½œä¸ºé™„åŠ ä¿¡æ¯**
- ä¼˜ç‚¹ï¼šå¯¹ç°æœ‰ä»£ç å½±å“è¾ƒå°
- ç¼ºç‚¹ï¼šä¸åˆ©äºå¯¹è¯å†å²çš„å®Œæ•´æ€§ï¼ŒæŸ¥è¯¢ä¸ä¾¿

**é‡‡ç”¨æ–¹æ¡ˆï¼šæ–¹æ¡ˆAï¼ˆå·¥å…·è°ƒç”¨ä½œä¸ºæ¶ˆæ¯ç±»å‹ï¼‰**

ç†ç”±ï¼š
1. å·¥å…·è°ƒç”¨æ˜¯å¯¹è¯æµç¨‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œåº”è¯¥å®Œæ•´è®°å½•
2. ä¾¿äºåç»­åŠŸèƒ½æ‰©å±•ï¼ˆå¦‚æœç´¢ã€å¼•ç”¨ç­‰ï¼‰
3. æ•°æ®ç»“æ„æ›´æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
4. ç¬¦åˆ"æ•°æ®å®Œæ•´æ€§ä¼˜å…ˆ"çš„åŸåˆ™

## ä¸‰ã€æŠ€æœ¯å®ç°

### 3.1 ç±»å‹å®šä¹‰æ‰©å±•

#### 3.1.1 Message ç±»å‹æ‰©å±•

```typescript
// src/types/chat-type.ts

// æ‰©å±•æ¶ˆæ¯è§’è‰²
export type MessageRole = 'user' | 'assistant' | 'system' | 'tool'

// æ¶ˆæ¯å†…å®¹ç±»å‹
export type MessageContentType = 'text' | 'tool_call'

// å·¥å…·ç±»å‹
export type ToolType = 'web_search' | 'file_search'

// å·¥å…·è°ƒç”¨çŠ¶æ€
export type ToolCallStatus = 'in_progress' | 'searching' | 'completed' | 'failed'

// å·¥å…·è°ƒç”¨ä¿¡æ¯
export interface ToolCallInfo {
  itemId: string          // å·¥å…·è°ƒç”¨çš„å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ ws_05a3ccd3...
  type: ToolType          // å·¥å…·ç±»å‹
  status: ToolCallStatus  // å½“å‰çŠ¶æ€
  query?: string          // æœç´¢æŸ¥è¯¢å†…å®¹ï¼ˆå®Œæˆæ—¶æ‰æœ‰ï¼‰
  outputIndex?: number    // åœ¨è¾“å‡ºä¸­çš„ç´¢å¼•ä½ç½®
  timestamp?: number      // æ—¶é—´æˆ³
}

// æ‰©å±• Message æ¥å£
export interface Message {
  id: bigint
  sessionId: bigint
  role: MessageRole           // æ–°å¢ 'tool' è§’è‰²
  content: string
  status: 'pending' | 'sending' | 'sent' | 'error'
  totalTokens?: number
  timestamp: number
  attachments?: Attachment[]
  
  // æ–°å¢å­—æ®µ
  contentType?: MessageContentType  // å†…å®¹ç±»å‹ï¼Œé»˜è®¤ 'text'
  toolCall?: ToolCallInfo          // å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼ˆä»…å½“ contentType ä¸º 'tool_call' æ—¶ï¼‰
}
```

#### 3.1.2 å›è°ƒæ¥å£æ‰©å±•

```typescript
// src/main/providers/index.ts

export interface StreamCallbacks {
  onChunk: (chunk: string) => void
  
  // æ–°å¢å·¥å…·è°ƒç”¨å›è°ƒ
  onToolCallStart?: (toolInfo: ToolCallInfo) => void      // å·¥å…·è°ƒç”¨å¼€å§‹
  onToolCallProgress?: (toolInfo: ToolCallInfo) => void   // å·¥å…·è°ƒç”¨è¿›åº¦
  onToolCallComplete?: (toolInfo: ToolCallInfo) => void   // å·¥å…·è°ƒç”¨å®Œæˆ
  
  onDone: () => void
  onError: (error: Error) => void
}
```

### 3.2 æ•°æ®åº“ Schema æ‰©å±•

```prisma
// prisma/schema.prisma

model Message {
  id          BigInt   @id
  sessionId   BigInt
  role        String   // user | assistant | system | tool
  content     String
  status      String   // pending | sending | sent | error
  totalTokens Int?
  createdAt   DateTime @default(now())
  
  // æ–°å¢å­—æ®µ
  contentType     String?  @default("text")  // text | tool_call
  toolType        String?  // web_search | file_search
  toolStatus      String?  // in_progress | searching | completed | failed
  toolQuery       String?  // å·¥å…·æŸ¥è¯¢å†…å®¹
  toolItemId      String?  // å·¥å…·è°ƒç”¨çš„ item_id
  toolOutputIndex Int?     // å·¥å…·åœ¨è¾“å‡ºä¸­çš„ç´¢å¼•
  
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([createdAt])
  @@index([contentType])  // æ–°å¢ç´¢å¼•ï¼Œä¾¿äºæŸ¥è¯¢å·¥å…·æ¶ˆæ¯
  @@index([toolItemId])   // æ–°å¢ç´¢å¼•ï¼Œä¾¿äºé€šè¿‡ itemId æŸ¥è¯¢
}
```

### 3.3 Provider å±‚å®ç°

#### 3.3.1 äº‹ä»¶ç›‘å¬å’Œå›è°ƒ

```typescript
// src/main/providers/openai-provider.ts

private async streamChatWithResponsesAPI(
  messages: Omit<Message, 'id' | 'timestamp'>[],
  config: AIConfig,
  callbacks: {
    onChunk: (chunk: string) => void
    onToolCallStart?: (toolInfo: ToolCallInfo) => void
    onToolCallProgress?: (toolInfo: ToolCallInfo) => void
    onToolCallComplete?: (toolInfo: ToolCallInfo) => void
    onDone: () => void
    onError: (error: Error) => void
  },
  abortSignal?: AbortSignal,
  tools: ToolType[] = []
): Promise<void> {
  // ... å‰ç½®ä»£ç  ...

  // ç”¨äºè·Ÿè¸ªå·¥å…·è°ƒç”¨çŠ¶æ€
  const toolCallsMap = new Map<string, ToolCallInfo>()
  
  // å¤„ç†æµå¼å“åº”
  for await (const chunk of stream) {
    if (abortSignal?.aborted) {
      return
    }

    const chunkType = (chunk as any).type

    switch (chunkType) {
      // 1. å·¥å…·è°ƒç”¨å¼€å§‹
      case 'response.output_item.added': {
        const event = chunk as any
        if (event.item?.type === 'web_search_call') {
          const toolInfo: ToolCallInfo = {
            itemId: event.item.id,
            type: 'web_search',
            status: 'in_progress',
            outputIndex: event.output_index,
            timestamp: Date.now()
          }
          toolCallsMap.set(event.item.id, toolInfo)
          callbacks.onToolCallStart?.(toolInfo)
          
          logDebug('Tool call started', toolInfo)
        }
        break
      }

      // 2. å·¥å…·è°ƒç”¨è¿›è¡Œä¸­
      case 'response.web_search_call.in_progress': {
        const event = chunk as any
        const toolInfo = toolCallsMap.get(event.item_id)
        if (toolInfo) {
          toolInfo.status = 'in_progress'
          callbacks.onToolCallProgress?.(toolInfo)
          
          logDebug('Tool call in progress', toolInfo)
        }
        break
      }

      // 3. å·¥å…·è°ƒç”¨æœç´¢ä¸­
      case 'response.web_search_call.searching': {
        const event = chunk as any
        const toolInfo = toolCallsMap.get(event.item_id)
        if (toolInfo) {
          toolInfo.status = 'searching'
          callbacks.onToolCallProgress?.(toolInfo)
          
          logDebug('Tool call searching', toolInfo)
        }
        break
      }

      // 4. å·¥å…·è°ƒç”¨å®Œæˆï¼ˆåˆæ­¥ï¼‰
      case 'response.web_search_call.completed': {
        const event = chunk as any
        const toolInfo = toolCallsMap.get(event.item_id)
        if (toolInfo) {
          toolInfo.status = 'completed'
          // æš‚ä¸è°ƒç”¨ onToolCallCompleteï¼Œç­‰å¾… output_item.done è·å–å®Œæ•´ä¿¡æ¯
          logDebug('Tool call completed (waiting for details)', toolInfo)
        }
        break
      }

      // 5. è¾“å‡ºé¡¹å®Œæˆ - è·å–å·¥å…·è°ƒç”¨çš„å®Œæ•´ä¿¡æ¯
      case 'response.output_item.done': {
        const event = chunk as any
        if (event.item?.type === 'web_search_call') {
          const toolInfo = toolCallsMap.get(event.item.id)
          if (toolInfo) {
            toolInfo.status = 'completed'
            toolInfo.query = event.item.action?.query
            callbacks.onToolCallComplete?.(toolInfo)
            
            logInfo('Tool call completed with details', toolInfo)
          }
        }
        break
      }

      // 6. æ–‡æœ¬å¢é‡ - ç°æœ‰é€»è¾‘
      case 'response.output_text.delta': {
        const textDeltaEvent = chunk as ResponseTextDeltaEvent
        if (textDeltaEvent.delta) {
          chunkCount++
          callbacks.onChunk(textDeltaEvent.delta)
        }
        break
      }

      // 7. å†…å®¹éƒ¨åˆ†æ·»åŠ  - ç°æœ‰é€»è¾‘
      case 'response.content_part.added': {
        const contentPartEvent = chunk as ResponseContentPartAddedEvent
        const part = contentPartEvent.part
        if (part.type === 'output_text' && 'text' in part && part.text) {
          chunkCount++
          callbacks.onChunk(part.text)
        }
        break
      }

      // 8. å“åº”å®Œæˆ
      case 'response.completed': {
        const event = chunk as any
        logInfo('Response completed', {
          totalOutputItems: event.response?.output?.length,
          usage: event.response?.usage
        })
        break
      }
    }
  }

  logInfo('OpenAI Responses API stream chat completed successfully', {
    model: config.model,
    totalChunks: chunkCount,
    totalToolCalls: toolCallsMap.size
  })
  callbacks.onDone()
}
```

### 3.4 Handler å±‚å®ç°

#### 3.4.1 å·¥å…·è°ƒç”¨æ¶ˆæ¯ç®¡ç†

```typescript
// src/main/handlers/ai-handler.ts

async function handleStreamChat(
  event: IpcMainInvokeEvent,
  params: StreamChatParams
): Promise<void> {
  // ... å‰ç½®ä»£ç  ...

  // ç”¨äºå­˜å‚¨å·¥å…·è°ƒç”¨æ¶ˆæ¯çš„ ID æ˜ å°„
  const toolCallMessageIds = new Map<string, bigint>()

  await provider.streamChat(
    messages,
    config,
    {
      // æ–‡æœ¬å—å›è°ƒ - ç°æœ‰é€»è¾‘
      onChunk: (chunk: string) => {
        accumulatedContent += chunk
        event.sender.send(`ai:streamChunk:${requestId}`, {
          requestId,
          chunk
        })
      },

      // å·¥å…·è°ƒç”¨å¼€å§‹ - åˆ›å»ºå·¥å…·æ¶ˆæ¯
      onToolCallStart: async (toolInfo: ToolCallInfo) => {
        try {
          const toolMessage = await messageRepository.create({
            sessionId: params.sessionId,
            role: 'tool',
            content: getToolCallStartMessage(toolInfo),
            status: 'sending',
            contentType: 'tool_call',
            toolType: toolInfo.type,
            toolStatus: toolInfo.status,
            toolItemId: toolInfo.itemId,
            toolOutputIndex: toolInfo.outputIndex
          })
          
          toolCallMessageIds.set(toolInfo.itemId, toolMessage.id)
          
          // é€šçŸ¥å‰ç«¯å·¥å…·è°ƒç”¨å¼€å§‹
          event.sender.send(`ai:toolCallStart:${requestId}`, {
            requestId,
            toolInfo,
            messageId: toolMessage.id,
            message: toolMessage
          })
          
          logInfo('Tool call started and message created', {
            toolInfo,
            messageId: toolMessage.id
          })
        } catch (error) {
          logError('Failed to create tool call message', error)
        }
      },

      // å·¥å…·è°ƒç”¨è¿›åº¦æ›´æ–°
      onToolCallProgress: async (toolInfo: ToolCallInfo) => {
        const messageId = toolCallMessageIds.get(toolInfo.itemId)
        if (messageId) {
          try {
            const updatedMessage = await messageRepository.update(messageId, {
              content: getToolCallProgressMessage(toolInfo),
              toolStatus: toolInfo.status
            })
            
            // é€šçŸ¥å‰ç«¯è¿›åº¦æ›´æ–°
            event.sender.send(`ai:toolCallProgress:${requestId}`, {
              requestId,
              toolInfo,
              messageId,
              message: updatedMessage
            })
            
            logDebug('Tool call progress updated', {
              toolInfo,
              messageId
            })
          } catch (error) {
            logError('Failed to update tool call message', error)
          }
        }
      },

      // å·¥å…·è°ƒç”¨å®Œæˆ
      onToolCallComplete: async (toolInfo: ToolCallInfo) => {
        const messageId = toolCallMessageIds.get(toolInfo.itemId)
        if (messageId) {
          try {
            const updatedMessage = await messageRepository.update(messageId, {
              content: getToolCallCompleteMessage(toolInfo),
              status: 'sent',
              toolStatus: toolInfo.status,
              toolQuery: toolInfo.query
            })
            
            // é€šçŸ¥å‰ç«¯å·¥å…·è°ƒç”¨å®Œæˆ
            event.sender.send(`ai:toolCallComplete:${requestId}`, {
              requestId,
              toolInfo,
              messageId,
              message: updatedMessage
            })
            
            logInfo('Tool call completed and message updated', {
              toolInfo,
              messageId
            })
          } catch (error) {
            logError('Failed to update tool call message', error)
          }
        }
      },

      // å®Œæˆå›è°ƒ - ç°æœ‰é€»è¾‘
      onDone: () => {
        event.sender.send(`ai:streamDone:${requestId}`, { requestId })
      },

      // é”™è¯¯å›è°ƒ - ç°æœ‰é€»è¾‘
      onError: (error: Error) => {
        event.sender.send(`ai:streamError:${requestId}`, {
          requestId,
          error: error.message
        })
      }
    },
    abortSignal,
    { tools: params.tools }
  )
}

// è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆå·¥å…·è°ƒç”¨çš„æ¶ˆæ¯å†…å®¹
function getToolCallStartMessage(toolInfo: ToolCallInfo): string {
  switch (toolInfo.type) {
    case 'web_search':
      return 'ğŸ” æ­£åœ¨æœç´¢ç½‘ç»œ...'
    case 'file_search':
      return 'ğŸ“ æ­£åœ¨æœç´¢æ–‡ä»¶...'
    default:
      return 'âš™ï¸ æ­£åœ¨æ‰§è¡Œå·¥å…·è°ƒç”¨...'
  }
}

function getToolCallProgressMessage(toolInfo: ToolCallInfo): string {
  switch (toolInfo.status) {
    case 'in_progress':
      return 'ğŸ” æœç´¢å‡†å¤‡ä¸­...'
    case 'searching':
      return 'ğŸ” æ­£åœ¨æœç´¢...'
    default:
      return getToolCallStartMessage(toolInfo)
  }
}

function getToolCallCompleteMessage(toolInfo: ToolCallInfo): string {
  const query = toolInfo.query ? `\næŸ¥è¯¢ï¼š${toolInfo.query}` : ''
  switch (toolInfo.type) {
    case 'web_search':
      return `âœ… ç½‘ç»œæœç´¢å®Œæˆ${query}`
    case 'file_search':
      return `âœ… æ–‡ä»¶æœç´¢å®Œæˆ${query}`
    default:
      return `âœ… å·¥å…·è°ƒç”¨å®Œæˆ${query}`
  }
}
```

### 3.5 Repository å±‚æ‰©å±•

```typescript
// src/main/repository/message.ts

export class MessageRepository {
  // æ‰©å±• create æ–¹æ³•æ”¯æŒå·¥å…·è°ƒç”¨å­—æ®µ
  async create(data: {
    sessionId: bigint
    role: string
    content: string
    status: string
    contentType?: string
    toolType?: string
    toolStatus?: string
    toolItemId?: string
    toolOutputIndex?: number
    toolQuery?: string
  }): Promise<Message> {
    const id = generateSnowflakeId()
    
    const message = await prisma.message.create({
      data: {
        id,
        sessionId: data.sessionId,
        role: data.role,
        content: data.content,
        status: data.status,
        contentType: data.contentType,
        toolType: data.toolType,
        toolStatus: data.toolStatus,
        toolItemId: data.toolItemId,
        toolOutputIndex: data.toolOutputIndex,
        toolQuery: data.toolQuery
      }
    })
    
    return this.mapToMessage(message)
  }

  // æ‰©å±• update æ–¹æ³•æ”¯æŒå·¥å…·è°ƒç”¨å­—æ®µ
  async update(
    id: bigint,
    data: {
      content?: string
      status?: string
      toolStatus?: string
      toolQuery?: string
    }
  ): Promise<Message> {
    const message = await prisma.message.update({
      where: { id },
      data
    })
    
    return this.mapToMessage(message)
  }

  // æ–°å¢ï¼šé€šè¿‡ toolItemId æŸ¥è¯¢å·¥å…·è°ƒç”¨æ¶ˆæ¯
  async findByToolItemId(toolItemId: string): Promise<Message | null> {
    const message = await prisma.message.findFirst({
      where: {
        toolItemId,
        contentType: 'tool_call'
      }
    })
    
    return message ? this.mapToMessage(message) : null
  }

  // æ˜ å°„æ•°æ®åº“è®°å½•åˆ° Message ç±»å‹
  private mapToMessage(record: any): Message {
    return {
      id: record.id,
      sessionId: record.sessionId,
      role: record.role,
      content: record.content,
      status: record.status,
      totalTokens: record.totalTokens,
      timestamp: record.createdAt.getTime(),
      contentType: record.contentType,
      toolCall: record.contentType === 'tool_call' ? {
        itemId: record.toolItemId,
        type: record.toolType,
        status: record.toolStatus,
        query: record.toolQuery,
        outputIndex: record.toolOutputIndex
      } : undefined
    }
  }
}
```

### 3.6 IPC é€šé“å®šä¹‰

```typescript
// src/common/constants/ipc.ts

export const IPC_CHANNELS = {
  // ... ç°æœ‰é€šé“ ...
  
  // å·¥å…·è°ƒç”¨ç›¸å…³
  TOOL_CALL_START: 'ai:toolCallStart',      // å·¥å…·è°ƒç”¨å¼€å§‹
  TOOL_CALL_PROGRESS: 'ai:toolCallProgress', // å·¥å…·è°ƒç”¨è¿›åº¦
  TOOL_CALL_COMPLETE: 'ai:toolCallComplete'  // å·¥å…·è°ƒç”¨å®Œæˆ
} as const
```

### 3.7 å‰ç«¯ç•Œé¢å®ç°

#### 3.7.1 å·¥å…·è°ƒç”¨æ¶ˆæ¯ç»„ä»¶

```typescript
// src/renderer/src/chat/tool-call-item.tsx

import { CheckCircle, XCircle } from 'lucide-react'
import { Message } from '@/types/chat-type'
import { LoadingSpinner } from '@/components/loading'

interface ToolCallItemProps {
  message: Message
}

export function ToolCallItem({ message }: ToolCallItemProps) {
  const { toolCall } = message
  
  if (!toolCall) return null

  // è·å–çŠ¶æ€å›¾æ ‡
  const getStatusIcon = () => {
    switch (toolCall.status) {
      case 'in_progress':
      case 'searching':
        return <LoadingSpinner className="w-4 h-4" />
      case 'completed':
        return <CheckCircle className="w-4 h-4 text-green-500" />
      case 'failed':
        return <XCircle className="w-4 h-4 text-red-500" />
      default:
        return null
    }
  }

  // è·å–å·¥å…·å›¾æ ‡
  const getToolIcon = () => {
    switch (toolCall.type) {
      case 'web_search':
        return 'ğŸ”'
      case 'file_search':
        return 'ğŸ“'
      default:
        return 'âš™ï¸'
    }
  }

  // è·å–å·¥å…·åç§°
  const getToolName = () => {
    switch (toolCall.type) {
      case 'web_search':
        return 'ç½‘ç»œæœç´¢'
      case 'file_search':
        return 'æ–‡ä»¶æœç´¢'
      default:
        return 'å·¥å…·è°ƒç”¨'
    }
  }

  // è·å–çŠ¶æ€æ–‡æœ¬
  const getStatusText = () => {
    switch (toolCall.status) {
      case 'in_progress':
        return 'å‡†å¤‡ä¸­...'
      case 'searching':
        return 'æœç´¢ä¸­...'
      case 'completed':
        return 'å·²å®Œæˆ'
      case 'failed':
        return 'å¤±è´¥'
      default:
        return ''
    }
  }

  return (
    <div className="tool-call-item bg-gray-50 dark:bg-gray-800 rounded-lg p-4 my-2 border border-gray-200 dark:border-gray-700 transition-all">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-lg">{getToolIcon()}</span>
        <span className="font-medium text-gray-900 dark:text-gray-100">
          {getToolName()}
        </span>
        <div className="flex items-center gap-1.5 ml-auto">
          {getStatusIcon()}
          <span className="text-sm text-gray-500 dark:text-gray-400">
            {getStatusText()}
          </span>
        </div>
      </div>
      
      {toolCall.query && (
        <div className="mt-2 text-sm text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900 rounded p-2">
          <span className="font-medium">æŸ¥è¯¢ï¼š</span>
          <span className="ml-1">{toolCall.query}</span>
        </div>
      )}
    </div>
  )
}
```

#### 3.7.2 æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶æ›´æ–°

```typescript
// src/renderer/src/chat/message-item.tsx

export function MessageItem({ message }: MessageItemProps) {
  // å·¥å…·è°ƒç”¨æ¶ˆæ¯
  if (message.contentType === 'tool_call') {
    return <ToolCallItem message={message} />
  }

  // æ™®é€šæ¶ˆæ¯ - ç°æœ‰é€»è¾‘
  return (
    <div className={cn(
      'message-item',
      message.role === 'user' ? 'user-message' : 'assistant-message'
    )}>
      {/* ... ç°æœ‰æ¶ˆæ¯å±•ç¤ºé€»è¾‘ ... */}
    </div>
  )
}
```

#### 3.7.3 èŠå¤©ç»„ä»¶ç›‘å¬å·¥å…·è°ƒç”¨äº‹ä»¶

```typescript
// src/renderer/src/page/chat.tsx

useEffect(() => {
  // ... ç°æœ‰ç›‘å¬é€»è¾‘ ...

  // ç›‘å¬å·¥å…·è°ƒç”¨å¼€å§‹
  const handleToolCallStart = (data: any) => {
    const { requestId, message } = data
    if (requestId === currentRequestId) {
      // æ·»åŠ å·¥å…·è°ƒç”¨æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
      chatStore.addMessage(message)
    }
  }

  // ç›‘å¬å·¥å…·è°ƒç”¨è¿›åº¦
  const handleToolCallProgress = (data: any) => {
    const { requestId, message } = data
    if (requestId === currentRequestId) {
      // æ›´æ–°å·¥å…·è°ƒç”¨æ¶ˆæ¯
      chatStore.updateMessage(message.id, message)
    }
  }

  // ç›‘å¬å·¥å…·è°ƒç”¨å®Œæˆ
  const handleToolCallComplete = (data: any) => {
    const { requestId, message } = data
    if (requestId === currentRequestId) {
      // æ›´æ–°å·¥å…·è°ƒç”¨æ¶ˆæ¯
      chatStore.updateMessage(message.id, message)
    }
  }

  window.electron.ipcRenderer.on('ai:toolCallStart', handleToolCallStart)
  window.electron.ipcRenderer.on('ai:toolCallProgress', handleToolCallProgress)
  window.electron.ipcRenderer.on('ai:toolCallComplete', handleToolCallComplete)

  return () => {
    window.electron.ipcRenderer.removeListener('ai:toolCallStart', handleToolCallStart)
    window.electron.ipcRenderer.removeListener('ai:toolCallProgress', handleToolCallProgress)
    window.electron.ipcRenderer.removeListener('ai:toolCallComplete', handleToolCallComplete)
  }
}, [currentRequestId])
```

## å››ã€å®ç°æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€å·¥å…·è°ƒç”¨æ˜¾ç¤ºï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

- [ ] **æ­¥éª¤1ï¼šæ•°æ®åº“ Schema æ‰©å±•**
  - [ ] 1.1 æ·»åŠ å·¥å…·è°ƒç”¨ç›¸å…³å­—æ®µåˆ° Message è¡¨
  - [ ] 1.2 åˆ›å»ºæ•°æ®åº“è¿ç§»
  - [ ] 1.3 æ‰§è¡Œè¿ç§»å¹¶éªŒè¯

- [ ] **æ­¥éª¤2ï¼šç±»å‹å®šä¹‰æ‰©å±•**
  - [ ] 2.1 æ‰©å±• `MessageRole` ç±»å‹ï¼Œæ·»åŠ  `tool` è§’è‰²
  - [ ] 2.2 å®šä¹‰ `ToolCallInfo` æ¥å£
  - [ ] 2.3 æ‰©å±• `Message` æ¥å£ï¼Œæ·»åŠ  `contentType` å’Œ `toolCall` å­—æ®µ
  - [ ] 2.4 æ‰©å±• `StreamCallbacks` æ¥å£ï¼Œæ·»åŠ å·¥å…·è°ƒç”¨å›è°ƒ

- [ ] **æ­¥éª¤3ï¼šProvider å±‚å®ç°**
  - [ ] 3.1 åœ¨ `streamChatWithResponsesAPI` ä¸­æ·»åŠ å·¥å…·è°ƒç”¨äº‹ä»¶ç›‘å¬
  - [ ] 3.2 å®ç° `response.output_item.added` äº‹ä»¶å¤„ç†ï¼ˆå·¥å…·è°ƒç”¨å¼€å§‹ï¼‰
  - [ ] 3.3 å®ç° `response.output_item.done` äº‹ä»¶å¤„ç†ï¼ˆå·¥å…·è°ƒç”¨å®Œæˆï¼‰
  - [ ] 3.4 è°ƒç”¨å·¥å…·å›è°ƒå‡½æ•°

- [ ] **æ­¥éª¤4ï¼šHandler å±‚å®ç°**
  - [ ] 4.1 å®ç° `onToolCallStart` å›è°ƒï¼Œåˆ›å»ºå·¥å…·æ¶ˆæ¯
  - [ ] 4.2 å®ç° `onToolCallComplete` å›è°ƒï¼Œæ›´æ–°å·¥å…·æ¶ˆæ¯
  - [ ] 4.3 æ·»åŠ å·¥å…·æ¶ˆæ¯ ID æ˜ å°„ç®¡ç†
  - [ ] 4.4 å®ç°è¾…åŠ©å‡½æ•°ç”Ÿæˆå·¥å…·æ¶ˆæ¯å†…å®¹

- [ ] **æ­¥éª¤5ï¼šRepository å±‚æ‰©å±•**
  - [ ] 5.1 æ‰©å±• `create` æ–¹æ³•æ”¯æŒå·¥å…·è°ƒç”¨å­—æ®µ
  - [ ] 5.2 æ‰©å±• `update` æ–¹æ³•æ”¯æŒå·¥å…·è°ƒç”¨å­—æ®µ
  - [ ] 5.3 æ‰©å±• `mapToMessage` æ–¹æ³•å¤„ç†å·¥å…·è°ƒç”¨æ•°æ®

### é˜¶æ®µäºŒï¼šå®æ—¶çŠ¶æ€æ›´æ–°ï¼ˆè¿›åº¦æ˜¾ç¤ºï¼‰

- [ ] **æ­¥éª¤6ï¼šProvider å±‚å¢å¼º**
  - [ ] 6.1 å®ç° `response.web_search_call.in_progress` äº‹ä»¶å¤„ç†
  - [ ] 6.2 å®ç° `response.web_search_call.searching` äº‹ä»¶å¤„ç†
  - [ ] 6.3 è°ƒç”¨ `onToolCallProgress` å›è°ƒ

- [ ] **æ­¥éª¤7ï¼šHandler å±‚å¢å¼º**
  - [ ] 7.1 å®ç° `onToolCallProgress` å›è°ƒ
  - [ ] 7.2 å®æ—¶æ›´æ–°æ•°æ®åº“ä¸­çš„å·¥å…·æ¶ˆæ¯çŠ¶æ€
  - [ ] 7.3 é€šè¿‡ IPC å‘é€è¿›åº¦æ›´æ–°äº‹ä»¶

- [ ] **æ­¥éª¤8ï¼šIPC é€šé“å®šä¹‰**
  - [ ] 8.1 æ·»åŠ  `ai:toolCallStart` é€šé“
  - [ ] 8.2 æ·»åŠ  `ai:toolCallProgress` é€šé“
  - [ ] 8.3 æ·»åŠ  `ai:toolCallComplete` é€šé“

### é˜¶æ®µä¸‰ï¼šUI å®ç°å’Œä¼˜åŒ–

- [ ] **æ­¥éª¤9ï¼šå‰ç«¯ç»„ä»¶å®ç°**
  - [ ] 9.1 åˆ›å»º `ToolCallItem` ç»„ä»¶
  - [ ] 9.2 å®ç°å·¥å…·å›¾æ ‡å’ŒçŠ¶æ€å›¾æ ‡
  - [ ] 9.3 å®ç°æŸ¥è¯¢å†…å®¹å±•ç¤º
  - [ ] 9.4 æ·»åŠ åŠ è½½åŠ¨ç”»

- [ ] **æ­¥éª¤10ï¼šæ¶ˆæ¯åˆ—è¡¨é›†æˆ**
  - [ ] 10.1 åœ¨ `MessageItem` ä¸­åˆ¤æ–­æ¶ˆæ¯ç±»å‹
  - [ ] 10.2 æ¸²æŸ“å·¥å…·è°ƒç”¨ç»„ä»¶
  - [ ] 10.3 å¤„ç†å·¥å…·æ¶ˆæ¯çš„æ—¶é—´æˆ³æ˜¾ç¤º

- [ ] **æ­¥éª¤11ï¼šèŠå¤©é¡µé¢ç›‘å¬**
  - [ ] 11.1 ç›‘å¬ `ai:toolCallStart` äº‹ä»¶
  - [ ] 11.2 ç›‘å¬ `ai:toolCallProgress` äº‹ä»¶
  - [ ] 11.3 ç›‘å¬ `ai:toolCallComplete` äº‹ä»¶
  - [ ] 11.4 æ›´æ–° chatStore çŠ¶æ€

- [ ] **æ­¥éª¤12ï¼šæ ·å¼ä¼˜åŒ–**
  - [ ] 12.1 è®¾è®¡å·¥å…·è°ƒç”¨æ¶ˆæ¯çš„è§†è§‰æ ·å¼
  - [ ] 12.2 æ·»åŠ çŠ¶æ€è¿‡æ¸¡åŠ¨ç”»
  - [ ] 12.3 é€‚é…æš—è‰²æ¨¡å¼
  - [ ] 12.4 ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤º

### é˜¶æ®µå››ï¼šæµ‹è¯•å’Œå®Œå–„

- [ ] **æ­¥éª¤13ï¼šåŠŸèƒ½æµ‹è¯•**
  - [ ] 13.1 æµ‹è¯•å·¥å…·è°ƒç”¨æ¶ˆæ¯åˆ›å»º
  - [ ] 13.2 æµ‹è¯•çŠ¶æ€æ›´æ–°æµç¨‹
  - [ ] 13.3 æµ‹è¯•å¤šä¸ªå·¥å…·è°ƒç”¨çš„æƒ…å†µ
  - [ ] 13.4 æµ‹è¯•å·¥å…·è°ƒç”¨å¤±è´¥çš„æƒ…å†µ

- [ ] **æ­¥éª¤14ï¼šè¾¹ç•Œæƒ…å†µå¤„ç†**
  - [ ] 14.1 å¤„ç†ç½‘ç»œä¸­æ–­æ—¶çš„å·¥å…·è°ƒç”¨çŠ¶æ€
  - [ ] 14.2 å¤„ç†ç”¨æˆ·å–æ¶ˆæ—¶çš„å·¥å…·è°ƒç”¨æ¸…ç†
  - [ ] 14.3 å¤„ç†å·¥å…·è°ƒç”¨è¶…æ—¶
  - [ ] 14.4 æ·»åŠ é”™è¯¯æç¤º

- [ ] **æ­¥éª¤15ï¼šæ€§èƒ½ä¼˜åŒ–**
  - [ ] 15.1 ä¼˜åŒ–å·¥å…·æ¶ˆæ¯æ›´æ–°é¢‘ç‡
  - [ ] 15.2 é¿å…ä¸å¿…è¦çš„æ•°æ®åº“å†™å…¥
  - [ ] 15.3 ä¼˜åŒ–å‰ç«¯æ¸²æŸ“æ€§èƒ½

## äº”ã€ç•Œé¢è®¾è®¡

### 5.1 å·¥å…·è°ƒç”¨æ¶ˆæ¯å±•ç¤ºæ ·å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ¶ˆæ¯                                â”‚
â”‚  ä»Šå¤©åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” ç½‘ç»œæœç´¢              â³ æœç´¢ä¸­...   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æŸ¥è¯¢ï¼šweather: Beijing, China     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ ï¼ˆçŠ¶æ€æ›´æ–°ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” ç½‘ç»œæœç´¢              âœ… å·²å®Œæˆ      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æŸ¥è¯¢ï¼šweather: Beijing, China     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI åŠ©æ‰‹                                 â”‚
â”‚  åŒ—äº¬ç›®å‰æ™´ï¼Œæ°”æ¸©çº¦ **2Â°Cï¼ˆ36Â°Fï¼‰**...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 çŠ¶æ€å›¾æ ‡

- **è¿›è¡Œä¸­/æœç´¢ä¸­**ï¼šæ—‹è½¬çš„åŠ è½½å›¾æ ‡ â³
- **å·²å®Œæˆ**ï¼šç»¿è‰²å¯¹å‹¾ âœ…
- **å¤±è´¥**ï¼šçº¢è‰²å‰å· âŒ

### 5.3 é¢œè‰²æ–¹æ¡ˆ

- **èƒŒæ™¯è‰²ï¼ˆæµ…è‰²æ¨¡å¼ï¼‰**ï¼š`bg-gray-50` + `border-gray-200`
- **èƒŒæ™¯è‰²ï¼ˆæš—è‰²æ¨¡å¼ï¼‰**ï¼š`bg-gray-800` + `border-gray-700`
- **æŸ¥è¯¢å†…å®¹èƒŒæ™¯**ï¼š`bg-white` / `bg-gray-900`
- **æˆåŠŸçŠ¶æ€**ï¼šç»¿è‰² `text-green-500`
- **å¤±è´¥çŠ¶æ€**ï¼šçº¢è‰² `text-red-500`

## å…­ã€æ•°æ®æµè®¾è®¡

### 6.1 å·¥å…·è°ƒç”¨åˆ›å»ºæµç¨‹

```
OpenAI Responses API
  â†“ response.output_item.added
Provider: onToolCallStart()
  â†“
Handler: åˆ›å»ºå·¥å…·æ¶ˆæ¯åˆ°æ•°æ®åº“
  â†“
Handler: å‘é€ IPC äº‹ä»¶
  â†“
Renderer: æ·»åŠ æ¶ˆæ¯åˆ° chatStore
  â†“
UI: æ¸²æŸ“å·¥å…·è°ƒç”¨ç»„ä»¶ï¼ˆè¿›è¡Œä¸­çŠ¶æ€ï¼‰
```

### 6.2 å·¥å…·è°ƒç”¨æ›´æ–°æµç¨‹

```
OpenAI Responses API
  â†“ response.web_search_call.searching
Provider: onToolCallProgress()
  â†“
Handler: æ›´æ–°æ•°æ®åº“ä¸­çš„æ¶ˆæ¯çŠ¶æ€
  â†“
Handler: å‘é€ IPC äº‹ä»¶
  â†“
Renderer: æ›´æ–° chatStore ä¸­çš„æ¶ˆæ¯
  â†“
UI: æ›´æ–°å·¥å…·è°ƒç”¨ç»„ä»¶çŠ¶æ€
```

### 6.3 å·¥å…·è°ƒç”¨å®Œæˆæµç¨‹

```
OpenAI Responses API
  â†“ response.output_item.done
Provider: onToolCallComplete()
  â†“
Handler: æ›´æ–°æ•°æ®åº“ï¼ˆçŠ¶æ€+æŸ¥è¯¢å†…å®¹ï¼‰
  â†“
Handler: å‘é€ IPC äº‹ä»¶
  â†“
Renderer: æ›´æ–° chatStore ä¸­çš„æ¶ˆæ¯
  â†“
UI: æ¸²æŸ“å®ŒæˆçŠ¶æ€ï¼ˆæ˜¾ç¤ºæŸ¥è¯¢å†…å®¹ï¼‰
```

## ä¸ƒã€æ³¨æ„äº‹é¡¹

### 7.1 æ€§èƒ½è€ƒè™‘

1. **æ•°æ®åº“å†™å…¥ä¼˜åŒ–**
   - å·¥å…·è°ƒç”¨çŠ¶æ€æ›´æ–°é¢‘ç¹ï¼Œè€ƒè™‘æ‰¹é‡æ›´æ–°æˆ–é˜²æŠ–
   - åªåœ¨å…³é”®çŠ¶æ€å˜åŒ–æ—¶å†™å…¥æ•°æ®åº“ï¼ˆå¼€å§‹ã€å®Œæˆã€å¤±è´¥ï¼‰
   - ä¸­é—´çŠ¶æ€ï¼ˆin_progress, searchingï¼‰å¯ä»¥åªæ›´æ–°å‰ç«¯ï¼Œä¸å†™æ•°æ®åº“

2. **å‰ç«¯æ¸²æŸ“ä¼˜åŒ–**
   - ä½¿ç”¨ React.memo ä¼˜åŒ–å·¥å…·è°ƒç”¨ç»„ä»¶
   - é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
   - ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§é‡æ¶ˆæ¯

### 7.2 é”™è¯¯å¤„ç†

1. **å·¥å…·è°ƒç”¨å¤±è´¥**
   - æ•è·å·¥å…·è°ƒç”¨é”™è¯¯äº‹ä»¶
   - æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º `failed`
   - æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

2. **ç½‘ç»œä¸­æ–­**
   - ä¿ç•™å·¥å…·è°ƒç”¨æ¶ˆæ¯çš„æœ€åçŠ¶æ€
   - æä¾›é‡è¯•æœºåˆ¶ï¼ˆå¦‚æœé€‚ç”¨ï¼‰

3. **ç”¨æˆ·å–æ¶ˆ**
   - æ¸…ç†æœªå®Œæˆçš„å·¥å…·è°ƒç”¨æ¶ˆæ¯
   - æˆ–æ ‡è®°ä¸ºå·²å–æ¶ˆçŠ¶æ€

### 7.3 å‘åå…¼å®¹

1. **ç°æœ‰æ¶ˆæ¯**
   - `contentType` é»˜è®¤ä¸º `text`
   - ç°æœ‰æ¶ˆæ¯æ— éœ€è¿ç§»ï¼Œç»§ç»­æ­£å¸¸æ˜¾ç¤º

2. **æ—§ç‰ˆæœ¬æ•°æ®**
   - æ–°å¢å­—æ®µå…¨éƒ¨å¯ç©º
   - ä¸å½±å“ç°æœ‰æ•°æ®è¯»å–

### 7.4 æ‰©å±•æ€§

1. **æ”¯æŒæ›´å¤šå·¥å…·ç±»å‹**
   - è®¾è®¡çµæ´»çš„ `ToolType` ç±»å‹
   - å·¥å…·å›¾æ ‡å’Œæ ·å¼å¯é…ç½®

2. **å·¥å…·ç»“æœå±•ç¤º**
   - é¢„ç•™æ‰©å±•æ¥å£æ˜¾ç¤ºå·¥å…·è¿”å›çš„è¯¦ç»†ç»“æœ
   - å¦‚æœç´¢ç»“æœã€æ–‡ä»¶ç‰‡æ®µç­‰

## å…«ã€åç»­ä¼˜åŒ–

### 8.1 åŠŸèƒ½å¢å¼º

1. **å·¥å…·è°ƒç”¨ç»“æœå±•ç¤º**
   - æ˜¾ç¤º web_search çš„æœç´¢ç»“æœæ‘˜è¦
   - æ˜¾ç¤ºå¼•ç”¨æ¥æºé“¾æ¥
   - æ”¯æŒç‚¹å‡»æŸ¥çœ‹å®Œæ•´ç»“æœ

2. **å·¥å…·è°ƒç”¨å†å²**
   - æ”¯æŒæŸ¥çœ‹å†å²å·¥å…·è°ƒç”¨è®°å½•
   - æ”¯æŒå¯¼å‡ºå·¥å…·è°ƒç”¨æ•°æ®

3. **å·¥å…·è°ƒç”¨ç»Ÿè®¡**
   - ç»Ÿè®¡å·¥å…·ä½¿ç”¨é¢‘ç‡
   - åˆ†æå·¥å…·è°ƒç”¨è€—æ—¶

### 8.2 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

1. **åŠ è½½åŠ¨ç”»**
   - æ›´ä¸°å¯Œçš„åŠ è½½åŠ¨ç”»æ•ˆæœ
   - çŠ¶æ€è¿‡æ¸¡åŠ¨ç”»

2. **äº¤äº’ä¼˜åŒ–**
   - æ”¯æŒæŠ˜å /å±•å¼€å·¥å…·è°ƒç”¨è¯¦æƒ…
   - æ”¯æŒå¤åˆ¶æŸ¥è¯¢å†…å®¹

3. **é€šçŸ¥æç¤º**
   - å·¥å…·è°ƒç”¨å®Œæˆæ—¶çš„é€šçŸ¥
   - å·¥å…·è°ƒç”¨å¤±è´¥æ—¶çš„æç¤º

## ä¹ã€æµ‹è¯•è®¡åˆ’

### 9.1 å•å…ƒæµ‹è¯•

- [ ] Provider å±‚å·¥å…·è°ƒç”¨äº‹ä»¶å¤„ç†
- [ ] Handler å±‚å·¥å…·æ¶ˆæ¯åˆ›å»ºå’Œæ›´æ–°
- [ ] Repository å±‚æ•°æ®åº“æ“ä½œ

### 9.2 é›†æˆæµ‹è¯•

- [ ] å®Œæ•´çš„å·¥å…·è°ƒç”¨æµç¨‹æµ‹è¯•
- [ ] å¤šä¸ªå·¥å…·è°ƒç”¨å¹¶å‘æµ‹è¯•
- [ ] å·¥å…·è°ƒç”¨å¤±è´¥åœºæ™¯æµ‹è¯•

### 9.3 UI æµ‹è¯•

- [ ] å·¥å…·è°ƒç”¨ç»„ä»¶æ¸²æŸ“æµ‹è¯•
- [ ] çŠ¶æ€æ›´æ–°è§†è§‰éªŒè¯
- [ ] å“åº”å¼å¸ƒå±€æµ‹è¯•

### 9.4 æ€§èƒ½æµ‹è¯•

- [ ] å¤§é‡å·¥å…·è°ƒç”¨æ—¶çš„æ€§èƒ½è¡¨ç°
- [ ] æ•°æ®åº“å†™å…¥æ€§èƒ½
- [ ] å‰ç«¯æ¸²æŸ“æ€§èƒ½

## åã€å‚è€ƒèµ„æ–™

### 10.1 ç›¸å…³æ–‡æ¡£

- [06.OPENAI_RESPONSES_API_DESIGN.md](./06.OPENAI_RESPONSES_API_DESIGN.md) - Responses API é›†æˆæ–¹æ¡ˆ
- [00.AI_CHAT_DESIGN.md](./00.AI_CHAT_DESIGN.md) - AI èŠå¤©åŠŸèƒ½è®¾è®¡
- [01.CHAT_SESSION_MANAGEMENT_DESIGN.md](./01.CHAT_SESSION_MANAGEMENT_DESIGN.md) - ä¼šè¯ç®¡ç†è®¾è®¡

### 10.2 API å‚è€ƒ

- OpenAI Responses API æ–‡æ¡£
- OpenAI SDK æ–‡æ¡£

### 10.3 å®ç°å‚è€ƒ

- å®é™…æ—¥å¿—åˆ†æï¼ˆè§é™„å½•ï¼‰
- Responses API äº‹ä»¶æµç¨‹

## é™„å½•ï¼šResponses API äº‹ä»¶æµç¨‹ç¤ºä¾‹

```json
// 1. å“åº”åˆ›å»º
{
  "type": "response.created",
  "response": {
    "status": "in_progress",
    "tools": [{ "type": "web_search" }]
  }
}

// 2. å·¥å…·è°ƒç”¨å¼€å§‹
{
  "type": "response.output_item.added",
  "item": {
    "id": "ws_05a3ccd3...",
    "type": "web_search_call",
    "status": "in_progress"
  }
}

// 3. å·¥å…·è°ƒç”¨è¿›åº¦
{
  "type": "response.web_search_call.in_progress",
  "item_id": "ws_05a3ccd3..."
}

// 4. å·¥å…·è°ƒç”¨æœç´¢ä¸­
{
  "type": "response.web_search_call.searching",
  "item_id": "ws_05a3ccd3..."
}

// 5. å·¥å…·è°ƒç”¨å®Œæˆï¼ˆåˆæ­¥ï¼‰
{
  "type": "response.web_search_call.completed",
  "item_id": "ws_05a3ccd3..."
}

// 6. å·¥å…·è°ƒç”¨å®Œæˆï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
{
  "type": "response.output_item.done",
  "item": {
    "id": "ws_05a3ccd3...",
    "type": "web_search_call",
    "status": "completed",
    "action": {
      "type": "search",
      "query": "weather: Beijing, China"
    }
  }
}

// 7. AI æ¶ˆæ¯å¼€å§‹
{
  "type": "response.output_item.added",
  "item": {
    "type": "message",
    "role": "assistant"
  }
}

// 8. æ–‡æœ¬å†…å®¹æµå¼è¾“å‡º
{
  "type": "response.output_text.delta",
  "delta": "åŒ—äº¬ç›®å‰æ™´..."
}

// 9. å“åº”å®Œæˆ
{
  "type": "response.completed",
  "response": {
    "status": "completed",
    "output": [
      { "type": "web_search_call", "status": "completed" },
      { "type": "message", "role": "assistant" }
    ]
  }
}
```

